---
title: "テスト戦略を考える"
category: "テスト"
---

# テスト戦略を考える
みなさま初めまして。
株式会社ニジボックスの田原と申します。

現在担当しているプロダクトでテスト戦略について考える機会があったので、その際に実施した調査や知見などをこちらの記事に書いていこうと思います！

## テストを書かないのは悪なのか？
テスト戦略を考えるきっかけになったのは、アサインされたプロジェクトで実施されているテストの大部分が手動で行われていることから始まりました。
手動テストはヒューマンエラーを起こすリスクがある上に実行工数も重いため、恒常的なデグレチェックやスルーテストは自動化したいなという思いがありました。

ユーザー体験向上のための案件が押し寄せる中で、開発効率向上のための原案がどこまで通るのかは結構未知でして、少なくとも「自動でテストやってくれるから便利なんすよ！」だけでは材料が不足していました。
また、そもそもこのプロジェクトには途中参画で、立ち上げに関わった開発者は既に不在。引き継ぎも資料ベースで、細かいところは憶測で進めるしかない、というような状況で、テスト戦略についてはかなり宙に浮いた状態でした。

現在のテスト戦略が、「このアプリケーション規模においては手動テストで充分である」と前任者が判断した上で組み立てられている可能性もありますし、もしそうであれば、それを覆すためにはそれなりの戦略を持って挑む必要がありそうだなと・・。

## そもそもテストって必要なのか？
漠然と手動テストは悪だと思っていましたが、果たして本当にそうなのか？をまず疑うことにしました。
昨今では、フロントエンド領域においてもテストを実施するべきであるという圧を結構感じますし、時代の流れ的にもそっちを向いています。
かくいう僕も、テストについてろくに知らない状態から「手動テストばかりで嫌な環境・・」などと思っていましたし、もっと言うと「今時のプロダクトでE2Eやってないとかダサくねー？」とか思ってました。

ただ、理解が及んでいないものを否定することはできないので、まずは理解するべきでしょうと。

では、手動テストに比重を置いても良い状況とは？

- アプリケーションの構造が非常にシンプルである
ユーザーインターフェースが主に静的であり、ユーザーの操作が少ない場合、自動化するメリットはあまりないと判断してもよさそうです。

- 短期的なプロジェクトで、機能追加もなく、テストの実施頻度が低い
新しい機能や変更が頻繁に行われないのであれば、恒常的にテストを回す必要がないので、自動テストを見送る選択肢も生まれそうです。

- 特定の業界やニッチな市場向けのプロダクトで、ユーザーのフィードバックを直接得ることが重要な場合
ユーザーのフィードバックを受けて機能を改善していくことが前提である場合、自動テストを構成してしまうとメンテナンスコストが上がるので、手動テストに比重を置くという判断は妥当です。

- 早期にマネタイズがしたい、デリバリー最優先のお急ぎプロダクト
とにかく最速でリリースする！品質は後回し！テストを書く暇があるなら機能を追加せよ！という案件。

他にもありそうですが、パッと思いつくのはこのくらいでした。
自動化するに越したことはないのかもしれませんが、それを優先するべきかどうかコスト面でも評価され、プロジェクトの方針によっては手動テストを採用することもあり得るなと理解しました。

その上で、自分達のプロダクトがこれに当てはまっているのかを考えていくと、戦略を見直すべきなのかどうかの基準が何となく見えてきます。

## テストの種類について
テスト戦略を考えるためにテストの種類について理解して、戦略のための選択肢を揃えていきます。

### テストの分類と範囲
- 静的解析
    
    コードが実行される前に、コードの品質やスタイル、潜在的なエラーを検出します。
    TypeScript、ESLint、Prettier などのツールがあります。  
    コードの一貫性を保ち、バグを未然に防ぐことを目的とします。
    
- 単体テスト
    
    個々の関数やコンポーネントが正しく動作するかを確認します。  
    Jest、Mocha、Jasmine などが利用されています。  
    リファクタリングや変更を行った際に、各機能が仕様通りに動作することを保証し、安全性を高めます。
    
- 結合テスト
    
    複数のモジュールを組み合わせて、相互作用やデータの流れが正しく機能するかを確認します。  
    Cypress、Testing Library などが利用されています。  
    モジュール間の統合が正しく行われているかを検証し、全体のビジネスロジックが期待通りであるかを確認します。
    
- E2Eテスト（End to Endテスト）
    
    実際のユーザー操作をシミュレートして、最も広範囲な結合テストを行います。  
    Cypress、Selenium、Playwright などのツールがあります。  
    ユーザーがアプリケーションを使用する際のシナリオを再現し、すべてのコンポーネントが連携して正しく機能しているかを確認します。


### 目的によって実施するテスト

- パフォーマンステスト
    
    アプリケーションの応答性や安定性、スケーラビリティを測定するテストです。  
    Lighthouse、WebPageTest、JMeter などのツールがあります。  
    アプリケーションが高負荷の状況でも適切に動作するかを検証し、ユーザー体験を最適化することを目指します。

- アクセシビリティテスト
    
    アプリケーションが多様なユーザーにとって利用可能であるのかを検証するテストです。  
    axe、WAVE などのツールがあります。  
    ユーザーインターフェースがすべての人にとってアクセス可能であることを確認し、標準やガイドラインに準拠していることを目指します。


## テスト戦略モデルについて
テスト戦略についても既にいくつかのモデルがあり、戦略のためのベースは先人の方々が築いてくれています。  

### テストピラミッド型

![テストピラミッド型](/images/Pyramid.png)

E2Eテストなど、上層のテストほど実際の環境に忠実であり、再現性が高いです。その分、実行時間も長く、コストもかかります。  
テストピラミッド型は、下層のテストに比重を置いた、費用対効果の高い戦略モデルです。実行時間も高速であり、単体テストなどの細かい機能レベルでテストを行うので、失敗した際のリスクも抑えられます。  
手動テストのような、失敗する可能性があり、かつ時間もかかる、という上層のテストの比重を軽くする戦略です。  

### アイスクリームコーン型

![アイスクリームコーン型](/images/IceCreamCone.png)

テストピラミッド型に反して、アイスクリームコーン型は上層のテストを多く実行する戦略モデルで、主にアンチパターンとして参照されることが多いです。  
上層のテストは運用のコストも高く、失敗するリスクもあり、実行時間も長いです。このようなテストに比重を置いている場合、日常の開発フローに影響が出るため、開発サイクルを鈍化させる要因になり得ます。  

### テスティングトロフィー型

![テスティングトロフィー型](/images/Trophy.png)

テスティングトロフィー型は、結合テストに比重を置いた戦略モデルです。  
Web上のコンテンツは、実際には機能単体で成立するものは少なく、UI操作によって外部へリクエストを送信したり、複数のモジュールを組み合わせて実現するのが基本的です。  
ユーザー操作を起点としたテストに比重を置くべきと考える場合、結合テストを充実させる必要があります。  


## テスト戦略を考える
テスト戦略について調べると、すぐにトレンドはテスティングトロフィー型であるという理解に行き着きます。  
テスティングトロフィー型を採用してテスト戦略を組んでいる方々のブログも結構多いですし、戦略の意図的にも納得しやすいものになっています。
ただ、自分は以下の人の記事が最も刺さりました。


テストは目的を達成するための手段であり、目的が明確でなければやる意味はありません。
戦略は目的を達成する為に存在するので、戦略を達成することは目的ではないのです。
特定のテスト戦略モデルに捉われてテストを量産しても、プロダクトにとってそのテストが本当に有用であるかどうかは、自分達が判断しなければなりません。

テストカバレッジは、テストの範囲を測るための有用な指標ですが、カバレッジ率80%を目指すだけのテストは目的を見失っていいます。
カバレッジ率が80%であっても、重要なビジネスロジックがテストされていなければ、目的は達成できていません。

テスト戦略は最終的に自分達の意思で組み立てるものであり、誰かのやり方を真似るだけで必ず効果があるというものでも、テストが沢山あれば良いという訳でもありません。


## 自分で考えるテスト戦略
テストの種類やテストの戦略についてはある程度理解したので、自分達のプロダクトにおいてどのようなテスト戦略を立てるべきなのかを考えます。  
まずは、現プロダクトのテスト戦略の状況について理解するべきです。

### 現プロダクトの戦略モデル
私の現在のプロダクトを、仮にモデル化した場合、どのような戦略になるのかを図にしてみました。

![バルーン型](/images/Balloon.png)

バルーンのように上層が膨らんでいるので、テスティングバルーン型などと勝手に名づけることにします。  
手動テストが全体の大部分を占めており、結合テストはほぼありません。  
このような戦略は、アプリケーションの構造がシンプルであり、テストの実施頻度が限られる短期的なプロジェクトにおいては効果がありそうです。  
また、リリース後のユーザーフィードバックを受けて改善を行うことを前提としている場合、結合テストを省略しても一定は問題がなさそうです。  

我々のプロジェクトがそれを意図しているのであれば、このテスティングバルーン型でも何も問題はないと判断するべきです。  
しかし、実際にはアプリの正常性を確認する為だけの基礎的なスルーテストすら手動で行なっており、それが高頻度で発生するため、手動テストの比重は重いです。これは実行コストだけでなくヒューマンエラーを起こしやすい仕組みであるとも言えます。  

また、ユーザーインタラクション起因による外部APIへのリクエストなども頻繁に発生しており、複数のモジュールの相互作用を確認することはアプリケーションにとって重要です。  
これらの観点が不足していることを考慮し、結合テストの充実化と、E2Eテストの導入をメインに検討していきます。  

### 目的を定める
現プロジェクトの課題は、手動テストの発生頻度が高く、その比重が重いこと、またヒューマンエラーが起こりやすいためリスクの高い運用であると言えます。  



#### 結合テストについて
現段階で結合テストはほぼ未実施の状態で、少なくとも意識的に書かれた形跡はありません。  
結合テストを充実化させるために、テスト設計書を作成することにします。現在のテストがどのようなテストケースで、どのような目的を持っているのかを明らかにし、不足している観点を網羅していきます。  
![テスト設計書](/images/testSheet.png)

また、テスト設計書を作成する上で、テストケースがドキュメントの役割を満たせているかどうかもチェックし、不足している場合は改善していきます。  
既存のテストでは、props から渡ってくるパラメータによって表示を切り替える場合のテストケースを「(props)の有無」などとして Assert していたりしました。  
これでは表示が切り替わる条件がこのテストから解明できないため、仕様を汲み取ることができません。こういった観点も修正対象に加えて、テスト設計書とテストケースがイコールになるよう手を加えていきます。  

テスト設計書では、