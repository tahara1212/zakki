---
title: "テスト戦略を考える"
category: "テスト"
---

# テスト戦略を考える
みなさま初めまして。
株式会社ニジボックスの田原と申します。

現在担当しているプロダクトでテスト戦略について考える機会があったので、その際に実施した調査や知見などをこちらの記事に書いていこうと思います！

## テストを書かないのは悪なのか？
テスト戦略を考えるきっかけになったのは、アサインされたプロジェクトで実施されているテストの大部分が手動で行われていることから始まりました。
手動テストはヒューマンエラーを起こすリスクがある上に実行工数も重いため、恒常的なデグレチェックやスルーテストは自動化したいなという思いがありました。

ユーザー体験向上のための案件が押し寄せる中で、開発効率向上のための原案がどこまで通るのかは結構未知でして、少なくとも「自動でテストやってくれるから便利なんすよ！」だけでは材料が不足していました。
また、そもそもこのプロジェクトには途中参画で、立ち上げに関わった開発者は既に不在。引き継ぎも資料ベースで、細かいところは憶測で進めるしかない、というような状況で、テスト戦略についてはかなり宙に浮いた状態でした。

現在のテスト戦略が、「このアプリケーション規模においては手動テストで充分である」と前任者が判断した上で組み立てられている可能性もありますし、もしそうであれば、それを覆すためにはそれなりの戦略を持って挑む必要がありそうだなと思い、テスト戦略について調べてみることにしました。

## そもそもテストって必要なのか？
漠然と手動テストは悪だと思っていましたが、果たして本当にそうなのか？をまず疑うことにしました。
昨今では、フロントエンド領域においてもテストを実施するべきであるという圧を結構感じますし、時代の流れ的にもそっちを向いています。
かくいう僕も、テストについてろくに知らない状態から「手動テストばかりで嫌な環境・・」などと思っていましたし、もっと言うと「今時のプロダクトでE2Eやってないとかダサくねー？」とか思ってました。

ただ、理解が及んでいないものを否定することはできないので、まずは理解するべきでしょうということで、考えてみました。

手動テストに比重を置いても良い状況とは？

- アプリケーションの構造が非常にシンプルである
ユーザーインターフェースが主に静的であり、ユーザーの操作が少ない場合、自動化するメリットはあまりないと判断してもよさそうです。

- 短期的なプロジェクトで、機能追加もなく、テストの実施頻度が低い
新しい機能や変更が頻繁に行われないのであれば、恒常的にテストを回す必要がないので、自動テストを見送る選択肢も生まれそうです。

- 特定の業界やニッチな市場向けのプロダクトで、ユーザーのフィードバックを直接得ることが重要な場合
ユーザーのフィードバックを受けて機能を改善していくことが前提である場合、自動テストを構成してしまうとメンテナンスコストが上がるので、手動テストに比重を置くという判断はあり得ます。

- 早期にマネタイズがしたい、デリバリー最優先のお急ぎプロジェクト
とにかく最速でリリースする！品質は後回し！テストを書く暇があるなら機能を追加せよ！という案件。

他にもありそうですが、パッと思いつくのはこのくらいでした。
自動化はやるに越したことはないのかもしれませんが、それを優先すべきかどうかはコスト面でも評価され、プロジェクトの方針によっては手動テストを採用することもあり得るなと理解しました。
なので、テスト書いてない！悪！と勝手に決めつけるのも良くないなと。それ自体が戦略であり、意図がしっかりとあれば問題ないのではと。

その上で、自分達のプロダクトがこれに当てはまっているのか？を考えていくと、戦略を見直すべきなのかどうかの基準が少しづつ見えてきました。

## テストの種類について
テスト戦略を考えるためにテストの種類について理解して、戦略のための選択肢を揃えていきます。

### テストの分類と範囲
- 静的解析
    
    コードが実行される前に、コードの品質やスタイル、潜在的なエラーを検出します。
    TypeScript、ESLint、Prettier などのツールがあります。  
    コードの一貫性を保ち、バグを未然に防ぐことを目的とします。
    
- 単体テスト
    
    個々の関数やコンポーネントが正しく動作するかを確認します。  
    Jest、Mocha、Jasmine などが利用されています。  
    リファクタリングや変更を行った際に、各機能が仕様通りに動作することを保証し、安全性を高めます。
    
- 結合テスト
    
    複数のモジュールを組み合わせて、相互作用やデータの流れが正しく機能するかを確認します。  
    Cypress、Testing Library などが利用されています。  
    モジュール間の統合が正しく行われているかを検証し、全体のビジネスロジックが期待通りであるかを確認します。
    
- E2Eテスト（End to Endテスト）
    
    実際のユーザー操作をシミュレートして、最も広範囲な結合テストを行います。  
    Cypress、Selenium、Playwright などのツールがあります。  
    ユーザーがアプリケーションを使用する際のシナリオを再現し、すべてのコンポーネントが連携して正しく機能しているかを確認します。


### 目的によって実施するテスト

- パフォーマンステスト
    
    アプリケーションの応答性や安定性、スケーラビリティを測定するテストです。  
    Lighthouse、WebPageTest、JMeter などのツールがあります。  
    アプリケーションが高負荷の状況でも適切に動作するかを検証し、ユーザー体験を最適化することを目指します。

- アクセシビリティテスト
    
    アプリケーションが多様なユーザーにとって利用可能であるのかを検証するテストです。  
    axe、WAVE などのツールがあります。  
    ユーザーインターフェースがすべての人にとってアクセス可能であることを確認し、標準やガイドラインに準拠していることを目指します。


## テスト戦略モデルについて
テスト戦略についても既にいくつかのモデルがあるので、こちらも参考にしていきます。

### テストピラミッド型

![テストピラミッド型](/images/Pyramid.png)

E2Eテストなど、上層のテストほど実際の環境に忠実であり、再現性が高いです。その分、実行時間も長く、コストもかかります。  
テストピラミッド型は、下層のテストに比重を置いた、費用対効果の高い戦略モデルです。実行時間も高速であり、単体テストなどの細かい機能レベルでテストを行うので、失敗した際のリスクも抑えられます。  
手動テストのような、失敗する可能性があり、かつ時間もかかる、という上層のテストの比重を軽くする戦略です。  

### アイスクリームコーン型

![アイスクリームコーン型](/images/IceCreamCone.png)

テストピラミッド型に反して、アイスクリームコーン型は上層のテストを多く実行する戦略モデルで、主にアンチパターンとして参照されることが多いです。  
上層のテストは運用のコストも高く、失敗するリスクもあり、実行時間も長いです。このようなテストに比重を置いている場合、日常の開発フローに影響が出るため、開発サイクルを鈍化させる要因になり得ます。  

### テスティングトロフィー型

![テスティングトロフィー型](/images/Trophy.png)

テスティングトロフィー型は、結合テストに比重を置いた戦略モデルです。  
Web上のコンテンツは、実際には機能単体で成立するものは少なく、UI操作によって外部へリクエストを送信したり、複数のモジュールを組み合わせて実現するのが基本的です。  
ユーザー操作を起点としたテストに比重を置くべきと考える場合、結合テストを充実させる必要があります。  


## テスト戦略を考える
テスト戦略について調べると、トレンドはテスティングトロフィー型であるという結論に割と早く行き着きます。  
テスティングトロフィー型を採用してテスト戦略を組んでいる方々のブログも結構多いですし、戦略の意図的にも納得しやすいものになっています。

#### なぜ結合テストに比重を置くべきなのか
フロントエンドにおいて単体のコンポーネントだけで成立する機能は少ないため、単体テストを量産することは最適とは言い切れないのです。
ユーザーの操作をより忠実に再現するのであればE2Eテストを行うべきですが、これにはコストが多く必要になります。
そうすると、結合テストが効果的にもコスト的にも一番バランスが良い、ということになり、テスティングトロフィー型の戦略モデルが推奨されていたりします。

ただ、自分は以下の人の記事が最も刺さりました。


テストは目的を達成するための手段であり、目的が明確でなければやる意味はありません。  
そして戦略は目的を達成する為に存在するので、戦略を達成することは目的ではないのです。  
特定のテスト戦略モデルに捉われてテストを量産しても、プロダクトにとってそのテストが本当に有用であるかどうかは、自分達が判断すべきです。  

例えば、テストカバレッジが80%を切らないようにしよう、という取り組みがあったとします。  
テストカバレッジはテストの範囲を測るための有用な指標ですが、カバレッジ率が80%であっても、重要なビジネスロジックがテストされていなければ目的は達成できていないことになります。  
手段の目的化を回避し、目的を明確にして戦略を考えることを重点的に意識します。

よって、テスティングトロフィーについては意識せず、あくまで参考程度として戦略を考えていきます。


#### 現在のテスト戦略の状況を知る
私の現在のプロダクトを、仮にモデル化した場合、どのような戦略になるのかを図にしてみました。

![バルーン型](/images/Balloon.png)

バルーンのように上層が膨らんでいるので、テスティングバルーン型などと勝手に名づけることにします。  
手動テストが全体の大部分を占めており、結合テストはほぼありません。  

我々のプロジェクトが意図的に手動テストに比重を置いているのであれば、このテスティングバルーン型でも何も問題はないと判断するべきです。  
しかし、実際にはアプリの正常性を確認する為だけの基礎的なスルーテストは高頻度で発生し、手動で行われています。これは実行コストだけでなくヒューマンエラーを起こしやすい仕組みであり高コストです。  
また、新たな機能追加が頻繁に行われ、アプリは成長線上の過程にいます。初期段階ではシンプルだったアプリ構成は次第に複雑化しており、自動テストの必要性は増しています。

単体テストや静的解析についてはすでに実施済みの状態なので、不足している結合テストの充実化と、E2Eテスト導入による手動テストの比率削減を狙って戦略を整えます。

## 必要なテストの基準
目的のためのテストを書くため、その意図を明確にしておく必要があります。
完璧なテストをいくらでも書けるのであればその方が良いですが、実際にはリソースに限りがあるため、どの観点を捨てるべきかを考える必要があります。

まずはコンポーネント毎に以下のような簡易的なテスト設計書を作成していきます。
![テスト設計書](/images/testSheet.png)

既存のテストを設計書に網羅していき、以下のような方針で基準を定めていきます。

- コンポーネントの目的を定め、それを達成するための機能
- 分岐処理が多く発生し、条件によって動作が変わるような複雑なロジックの機能
- 外部ライブラリに依存している機能
- 
コンポーネントの目的を明記して、それを達成するための機能は


#### 結合テストについて
現段階で結合テストはほぼ未実施の状態で、少なくとも意識的に書かれた形跡はありません。  
結合テストを充実化させるために、テスト設計書を作成することにします。現在のテストがどのようなテストケースで、どのような目的を持っているのかを明らかにし、不足している観点を網羅していきます。  

また、テスト設計書を作成する上で、テストケースがドキュメントの役割を満たせているかどうかもチェックし、不足している場合は改善していきます。  
既存のテストでは、props から渡ってくるパラメータによって表示を切り替える場合のテストケースを「(props)の有無」などとして Assert していたりしました。  
これでは表示が切り替わる条件がこのテストから解明できないため、仕様を汲み取ることができません。こういった観点も修正対象に加えて、テスト設計書とテストケースがイコールになるよう手を加えていきます。  

テスト設計書では、