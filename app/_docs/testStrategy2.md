---
title: "テスト戦略を考える"
category: "テスト"
---

# テスト戦略を考える
みなさま初めまして。
株式会社ニジボックスの田原と申します。

現在担当しているプロダクトでテスト戦略について考える機会があったので、その際に実施した調査や知見などをこちらの記事に書いていこうと思います！

これまで簡単なテストを書く機会はあったものの、設計や戦略の段階からテストに向き合うことは初の試みなので、暖かい目で見ていただけると幸いです！

## テスト戦略を考えるきっかけ
テスト戦略を考えるきっかけになったのは、アサインされたプロジェクトで実施されているテストの大部分が手動で行われていることから始まりました。  
手動テストはヒューマンエラーを起こすリスクがある上に実行工数も重いので、恒常的なデグレチェックやスルーテストは自動化したいなという思いがありました。

プロジェクトには途中参画で、前任の方々からバトンタッチしました。基盤は既に構築されていますが細かい戦略は宙に浮いた状態で、現在のテスト戦略が「このアプリケーション規模においては手動テストで充分である」と判断された上で成り立っているのかなどは判断できない状況でした。  

引き継ぎ時点でその判断ができないということは、現在のテスト戦略自体に強い意志がないとも判断できますが、何よりも後任の僕がテストの戦略について何も分かっていないということ自体が大問題でした。

このまま理解の及ばない流れに乗っかり続けるのは危険だなという思いがあり、戦略から見直していくことにしました。

## 手動テストは絶対に悪なのか？
漠然と手動テストは悪だと思っていましたが、そもそも本当にそうなのか？をまず疑うことにしました。  

昨今では、フロントエンド領域においてもテストを実施するべきであるという圧を感じますし、時代の流れ的にもそっちを向いています。  

僕自身も、テストについてろくに知らない状態から「手動テストばかりで嫌な環境・・」などと思っていましたし、もっと言うと「今時のプロダクトでE2Eやってないとかダサくねー？」とか思ってました。

ただ、理解が及んでいないものを否定することはできないので、まずは手動テストが選ばれる理由を考えてみました。

#### 手動テストに比重を置いても良い状況とは？

- アプリケーションの構造が非常にシンプルである

    ユーザーインターフェースが主に静的であり、ユーザーの操作が少ない場合、自動化するメリットはあまりないと判断してもよさそうです。

- 短期的なプロジェクトで、機能追加もなく、テストの実施頻度が低い

    新しい機能や変更が頻繁に行われないのであれば、恒常的にテストを回す必要がないので、自動テストの導入をコスパ観点で見送る選択肢も生まれそうです。

- 特定の業界やニッチな市場向けのプロダクトで、ユーザーのフィードバックを直接得ることが重要な場合

    ユーザーのフィードバックを受けて機能を改善していくことが前提である場合、自動テストを構成してしまうとメンテナンスコストが上がるので、手動テストに比重を置くという判断はあり得ます。

- 早期にマネタイズがしたい、デリバリー最優先のお急ぎプロジェクト

    とにかく最速でリリースする！品質は後回し！テストを書く暇があるなら機能を追加せよ！という案件。

他にもありそうですが、パッと思いつくのはこのくらいでした。  

テストの自動化はやるに越したことはないのかもしれませんが、それを優先すべきかどうかはコスト面でも評価され、プロジェクトの方針によっては手動テストを採用することもあり得るなと理解しました。  

なので「テスト書いてない！悪！」と勝手に決めつけるのも良くないなと。それ自体が戦略であり、意図がしっかりとあれば問題ないのではと思えてきました。

その上で、自分達のプロジェクトがこれに当てはまっているのか？を考えていくと、戦略を見直すべきなのかどうかの基準が少しづつ見えてきました。

## テストの種類について
テスト戦略を考えるためにテストの種類について理解しておきます。

### テストの分類と範囲
- 静的解析
    
    コードが実行される前に、コードの品質やスタイル、潜在的なエラーを検出します。  
    TypeScript、ESLint、Prettier などのツールがあります。  
    コードの一貫性を保ち、バグを未然に防ぐことを目的とします。
    
- 単体テスト
    
    個々の関数やコンポーネントが正しく動作するかを確認します。  
    Jest、Mocha、Jasmine などが利用されています。  
    リファクタリングや変更を行った際に、各機能が仕様通りに動作することを保証し、安全性を高めます。
    
- 結合テスト
    
    複数のモジュールを組み合わせて、相互作用やデータの流れが正しく機能するかを確認します。  
    Cypress、Testing Library などが利用されています。  
    モジュール間の統合が正しく行われているかを検証し、全体のビジネスロジックが期待通りであるかを確認します。
    
- E2Eテスト（End to Endテスト）
    
    実際のユーザー操作をシミュレートして、最も広範囲な結合テストを行います。  
    Cypress、Selenium、Playwright などのツールがあります。  
    ユーザーがアプリケーションを使用する際のシナリオを再現し、すべてのコンポーネントが連携して正しく機能しているかを確認します。


### 目的によって実施するテスト

- パフォーマンステスト
    
    アプリケーションの応答性や安定性、スケーラビリティを測定するテストです。  
    Lighthouse、WebPageTest、JMeter などのツールがあります。  
    アプリケーションが高負荷の状況でも適切に動作するかを検証し、ユーザー体験を最適化することを目指します。

- アクセシビリティテスト
    
    アプリケーションが多様なユーザーにとって利用可能であるのかを検証するテストです。  
    axe、WAVE などのツールがあります。  
    ユーザーインターフェースがすべての人にとってアクセス可能であることを確認し、標準やガイドラインに準拠していることを目指します。

現在のプロダクトにおいては「静的解析、単体テスト」は導入済みで、それ以外の観点は手動テストに巻き取られているか、不足している、という状況でした。


## テスト戦略モデルについて
テスト戦略についても既にいくつかのモデルがあるので、こちらも参考にしていきます。

### テストピラミッド型

![テストピラミッド型](/images/Pyramid.png)

テストピラミッド型は、下層のテストに比重を置いた、費用対効果の高い戦略モデルです。  
実行時間も高速であり、単体テストなどの細かい機能レベルでテストを行うので、失敗した際のリスクも抑えられます。手動テストのような、失敗する可能性があり、かつ時間もかかる、という上層のテストの比重を軽くする戦略です。  

### アイスクリームコーン型

![アイスクリームコーン型](/images/IceCreamCone.png)

テストピラミッド型に反して、アイスクリームコーン型は上層のテストを多く実行する戦略モデルで、主にアンチパターンとして参照されることが多いです。  
上層のテストは運用コストが高い上に失敗するリスクもあり、実行時間も長いです。このようなテストに比重を置いている場合、開発サイクルに影響が出る可能性があります。  

### テスティングトロフィー型

![テスティングトロフィー型](/images/Trophy.png)

テスティングトロフィー型は、結合テストに比重を置いた戦略モデルです。  
Web上のコンテンツは、実際には機能単体で成立するものは少なく、UI操作によって外部へリクエストを送信したり、複数のモジュールを組み合わせて実現するのが基本的です。  
ユーザーの操作を忠実に再現するのであればE2Eテストを行うべきですが、それなりのコストが発生します。  
そうすると、結合テストが効果的にもコスト的にも一番バランスが良い、ということになり、テスティングトロフィー型の戦略モデルが推奨されていたりします。 


### 現在のテスト戦略
僕が担当しているプロダクトの現在のテスト戦略に最も近しいのは、アイスクリームコーン型でした。  
せっかくなので図にしてみます。アイスクリームコーン型よりもプロセスが欠損しています。  
![バルーン型](/images/Balloon.png)

上層が膨らんでいるので、バルーン型などと勝手に名づけることにします。  
手動テストが全体の大部分を占めており、結合テストはほぼありません。  
我々のプロジェクトが意図的に手動テストに比重を置いているのであれば、このようなバルーン型でも問題はないと判断するべきです。  

## テスト戦略を考える
プロダクトの現状と、テストについて調べた内容から、テスト戦略について考え直していきます。  

テスト戦略について調べると、トレンドはテスティングトロフィー型であるという結論に割と早く行き着きます。  
テスティングトロフィー型を採用してテスト戦略を組んでいる方々のブログも結構多いですし、戦略の意図的にも納得しやすいものになっています。

ただ、自分は以下の人の記事が最も刺さりました。  
https://zenn.dev/ik_takagishi/books/5c6c9fe3a7ad2c

QCDのバランスはプロジェクトによって変わりますが、全てが高水準であるならその方がいいでしょう。  
しかし、実際にはリソースに限りがあり、バランスはトレードオフです。  

テストにおいても、全てを達成できるのであれば戦略について悩む必要はありません。  
リソースや技術力に限りがあり、何もかもを実施できないのであれば、優先度を定める必要があります。  
そのために「目的」を明確にして、それを達成するためのテストを最優先とする、という戦略を考えていきます。  

### 目的ファーストで考える
テストは目的を達成するための手段であり、目的が明確でなければやる意味はありません。  
そして戦略は目的を達成する為に存在するので、戦略を達成することは目的ではないのです。  

特定のテスト戦略モデルに捉われてテストを量産しても、プロダクトにとってそのテストが本当に有用であるかどうかは、自分達が判断しなければなりません。  

テストカバレッジはテストの範囲を測るための有用な指標ですが、カバレッジ率が80%であっても、重要なビジネスロジックがテストされていなければ目的は達成できていないことになります。  

手段の目的化を回避し、目的を明確にして戦略を考えることを重点的に意識します。  
よって、テスティングトロフィーを目指すのではなく、これまでの戦略モデルを参考とした上で自分達の戦略を考えていきます。

### 自分達の戦略
現在のプロジェクトのテスト戦略はバルーン型です。  
テストの大部分は手動テストで賄われていますが、これが是であるパターンを前項で洗い出した内容に当てはめて考えます。  

現時点で、僕らが開発するアプリは成長線上の過程にいます。日々新しい機能の追加が行われ、ユーザビリティ向上の為の様々な案件が立案されています。  

初期段階ではシンプルだったアプリ構成は次第に複雑化しており、機能追加によるデグレ影響を確認する必要性は増加していると判断できます。  

また、アプリの正常性を確認する為の基礎的なスルーテストは高頻度で発生し、全て手動です。  
これはアプリ影響の少ないリファクタ対応などをデプロイしても必ず実施される工程となり、高コストでリスクのある運用になっています。  

特に結合テストはほぼ未実施の状態であり、ユーザー操作を起点とするようなテストも全て手動テストに巻き取られているため、この状態のまま機能追加が行われていくといずれバルーンが破裂します。  

手動テストの比重を軽くして、全体の負荷を軽減する仕組みはプロジェクトにとって最も重要です。  

よって、不足している結合テストの充実化と、E2Eテスト導入による手動テストの比率削減を戦略の主軸として狙うことにします。  
戦略としては非常にシンプルで、これ以上のことは特に意識せず、単体テストと結合テストのバランスなども一旦は考慮しません。  

## 結合テストを作成する
目的のためのテストを書くので、その意図は明確にしておく必要があります。  
何もかもを実施するリソースは無いので、どの観点を捨てるべきかを考えなければいけません。  

### テスト設計書の作成
結合テストは現時点でほぼ未実施の状態のため、結合テストとして必要な観点を洗い出します。  

まずは既存の状況を把握するため、コンポーネント毎に以下のようなテスト設計書を作成していきます。
![テスト設計書](/images/testSheet.png)

設計書の目的は現状の理解と改善、目的の明確化、結合テスト観点の追加、のために行います。  
作成する過程で単体テストの見直しも行ない、不足している観点はタスクとして追記しておきます。  

### 優先度の基準
現状のテスト範囲と傾向を理解し、優先度の高いテストの基準を以下のような方針で定めていきます。  
- ユーザーが目的を達成するための機能
- 複雑なロジックの機能（分岐処理、条件による状態変化）
- 外部ライブラリに依存している機能
- セキュリティに関する機能

例えば、「ボタンをクリックした際に特定のアクションが実行される」というようなテストは優先度が高く、「ボタンをクリックした際にボタンの状態が変わる」というようなテストは優先度が低いです。  

機能の核心ではない観点のテストや、自明なロジックのテストは実装基準から排除して、優先度の高い機能のテストを充実させるようにします。  

### 結合テストの観点
テスト設計書で洗い出した不足観点から、結合テストとして実施すべきものを実装していきます。  
特に、現時点では以下のような観点のテストを実施すべきと判断しました。

- データ取得と表示機能
- ページ間のナビゲーション
- イベントトリガーによる処理の連鎖

現状これらの殆どが手動テストで巻き取られているため、結合テストとして自動化していきます。  
ページ間のナビゲーションはE2Eの方でやればいいのですが、データの受け渡しやAPI呼び出しなど、重要な観点がある場合のみチェックするようにします。  

結合テストの実施は React Testing Library や Storybook の Play Functionを使用することにしました。  

このプロダクトではコンポーネントの設計パターンが明確ではなく、単体テストが各コンポーネントにぶら下がっている状態なので、Container Component に結合テスト、Presentational Component に単体テスト、というような棲み分けを行うことは改修コストが重いので断念しました。  

代わりに棲み分けについてはテストファイルを分離して範囲を定めることにします。
- MyComponent.test.js（単体テスト）  
- MyComponent.integration.test.js（結合テスト）

### 結合テストの実装
テストファイルを作成したら、実際にテストを実装していきます。上記で挙げた結合テストの観点に基づいてテスト設計書を定義し、目的や具体的なアサーションを決めていきます。  

テストの実装が完了したら、CI/CDパイプラインに組み込むことで、コードがプッシュされるたびに自動で実行されるようにしておきます。

## E2Eテストを導入する
手動で行われていたテストの再現率はE2Eテストが最も高いです。  
論点はエビデンスで、これまで手動で確認してきたものをシステムに移行する場合、システムが信用できるという相応のエビデンスを示さなければなりません。  
E2Eテスト自体に不備があって、問題のある状態をパスしてしまっている場合、手動テストの方が信頼できるという結果になってしまうため、それだけは避けなくてはなりません。  

### 自動化するテストケースの基準
デプロイ毎に実施される恒常的なスルーテストをE2Eに置き換えていきます。  
既存のスルーテストのテストケースを確認し、どこまでの観点を満たせるのかを確認します。  

既存のテストケースの内容はここには載せられませんが、エクセルで作成された基本的なフォーマットで、確認手順や期待値、環境、結果について記載されています。  
現状は以下のような傾向のテストケースがあるので、これを網羅していきます。  
- 表示確認（ビジュアルリグレッションテスト）
- 疎通確認（ページ遷移）
- 接続確認（データ取得）

### 実装
Playwright を使用して、E2Eテストを実施していきます。  
最も懸念したいのが、手動で実施していた頃と比較して情報量が低下することで、可能な限り据え置きのエビデンスが出せるようにしたいなと思いました。  

具体的な手順は割愛しますが、Playwright を導入してテストケースの一部を自動化し、最初に吐き出したレポートが以下です。  
![最初のレポート](/images/report01.png)

このテストで何が行われていたのかは、実装者であれば解明できますが、エビデンスとしては情報が分かりづらいです。  
テストの具体的な実行手順を以下のようにステップを切り分けて書き出し、レポートを見やすく改良していきます。

```
test('ヘッダーリンクの遷移テスト', async ({ page }) => {
  await test.step('トップページにアクセスする', async () => {
    await page.goto('https://example.com');
    await expect(page).toHaveTitle('Example Domain');
  });

  // ...
});
```

レポート出力結果は以下。
![最初のレポート](/images/report02.png)