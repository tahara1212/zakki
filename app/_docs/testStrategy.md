---
title: "テスト戦略を考える"
category: "テスト"
---

# テスト戦略を考える
ウェブアプリケーションが複雑化した近年では、動的なコンテンツやインタラクティブな機能を持つウェブアプリが増加し、フロントエンド領域においてもテストが重要視されるようになりました。  

漠然と「テストを導入すべきである」という圧を感じるようにはなったものの、具体的なテスト戦略について考えるのはとても難しいです。  
テストは品質を担保するための義務ではなく、目的を達成するための手段であり、その目的や優先度はプロダクトによって異なります。  

他のプロダクトのテスト戦略をそのまま模倣しても、自分たちのプロダクトにとってその戦略が効果的とは限りません。  
何を達成したいかによって、戦略は多様に変化するので、テスト戦略に関する明確な答えを一概に見つけることは難しく、自分たちに合った戦略を考える必要があります。

## この記事で書きたいこと
- テスト戦略を考えるきっかけ
- なぜテストをするのか
- テストの種類と分類
- どのようにテスト戦略を考えるのか
- 自分で考えるテスト戦略

## テスト戦略を考えるきっかけ
私が現在のプロダクトに参画した時、アプリケーションの基盤構築は既に前任の方々によって実装済みの状態で、私が担当するのは主に運用やエンハンス系の案件でした。   

私の参画と同時に前任の開発チームは全て離任しており、直接のやり取りができる引き継ぎ期間などはなく、ドキュメントベースでそれが行われました。アプリの構成や戦略については、ドキュメントに書いてあることが全てであり、ここに記載されていない情報は憶測で理解するしかありませんでした。

開発を進める内に、段々と引き継ぎ資料の網羅不足に気づき始め、開発のやりづらさに悩むようになりました。  
特にテスト戦略については引き継ぎ資料に何も残されておらず、単体テストは実施されているものの、結合テストやE2Eテストは未実施の状態でした。  

主要なテストの大部分は手動テストで行われていて、それも検証チームのような役割を持ったエンジニアが担当するのではなく、ディレクターがテストケースを作成して手動で確認を行なっているような状態でした。  

「このアプリケーション規模においてはテストにコストをかけない」という、これ自体が戦略であった可能性もあります。  
しかし、それが資料に明記されていないのであればその程度の戦略であると判断するしかなく、前任者の意図がどうであれ、現時点で課題を感じるのであればそれを解消すべきと考えました。  

とはいえ、テスト戦略どころかフロントエンドテストに関する経験も乏しかったので、まずはテストの目的や種類、プロダクトごとのテスト戦略について調べてみて、自分なりの考えを記事として執筆することにしました。

## なぜテストをするのか
テストの目的は、プロダクトの指針やゴールに強く依存しています。  

テストの自動化によって負荷を軽減するとしても、仕組み化するためのコストが発生し、機能が追加されればその観点を自動テストにも落とし込む必要があり、様々なメンテナンスコストも発生します。  
仮に手動テストの負荷を軽減できたとしても、ユーザーにとって直接的な恩恵がないのであれば、ここにコストを費やす優先度は低いと判断されたりします。  

早期に収益化を目指すアプリケーションなどにおいては、デリバリーが最優先であるため、テストが煩わしく感じることもあります。  
テストは、短期的な観点では開発効率を妨げる印象を与えます。テストを書くというだけで余計な工数が発生し、それ自体の恩恵も実装時には実感しづらいため、「テストを書く暇があれば開発を進めれば良いのでは？」という考えが生まれるのです。  

新機能のリリースを急ぐ際にテストを省略すると、開発の効率が向上するかもしれません。しかし、中長期的には、機能追加や仕様変更が積み重なることでシステムが複雑化し、保守が難しくなります。結果として、テストがないことで既存機能に不具合が生じ、長期的なデリバリーの遅延を招くことになります。

持続的な開発サイクルを実現するためには、テストは非常に重要ですが、この価値を実感するには少し時間がかかります。非エンジニアの場合は特に理解が難しい領域になってきます。よって、テストの価値はエンジニアが率先してプレゼンしていくべきであり、その為にテストで何を防ぐのか、プロダクトにとってどのような恩恵をもたらすのかを分析したテスト戦略が必要になってきます。

「テストを書かないのは悪である」という風潮を実感する中で難しいのは、そうは言ってもただテストを書けばいいというものでもないということです。  

目的や意図の無いテストを乱立することは効果的ではなく、余計なコストが発生するばかりか、テスト自体が技術負債として残ることもあります。  

カバレッジが良い例ですが、テストカバレッジは、テストの範囲を測るための有用な指標であり、目的ではありません。意図もなくカバレッジ率を重視して過剰にテストを書きすぎると、本来の目的を見失っていきます。  
カバレッジ率が80%であっても、重要なビジネスロジックがテストされていなければ、目的は達成できていません。適切なカバレッジを設定するためには、プロダクトにおけるリスクの高い部分や重要な機能に重点を置いたテスト計画を立てることが必要です。カバレッジはあくまで一つの目安として活用し、実際のテストの目的と整合させることが重要です。  

テストは目的があって初めて成立するものであり、義務としてやり続けるようなものではありません。  
プロダクトの方針として、テストにコストを費やすことを諦めているのであれば、それも目的を達成するための一つの戦略です。  

しかし、テストの本質的な価値を理解しないまま、プロダクトがテストを見放しているのであれば、それは大問題です。エンジニアが率先して改善していくべきでしょう。  
テストの価値を知らない人間にそれを教えることも、エンジニアの手腕の一つです。  

テストの価値を明確にし、プロダクト固有の目的や意図に沿ってテストを設計していくことがテスト戦略です。

## テストの種類を知る
テスト戦略を考えるためには、選択肢について知る必要があります。これを理解していない状態では、何から考えて良いのかすら判断できません。  
これについては決まった形がある分、テスト戦略を考えるよりもずっと簡単です。

### テストの分類と範囲
- 静的解析
    
    コードが実行される前に、コードの品質やスタイル、潜在的なエラーを検出します。
    TypeScript、ESLint、Prettier などのツールがあります。  
    コードの一貫性を保ち、バグを未然に防ぐことを目的とします。
    
- 単体テスト
    
    個々の関数やコンポーネントが正しく動作するかを確認します。  
    Jest、Mocha、Jasmine などが利用されています。  
    リファクタリングや変更を行った際に、各機能が仕様通りに動作することを保証し、安全性を高めます。
    
- 結合テスト
    
    複数のモジュールを組み合わせて、相互作用やデータの流れが正しく機能するかを確認します。  
    Cypress、Testing Library などが利用されています。  
    モジュール間の統合が正しく行われているかを検証し、全体のビジネスロジックが期待通りであるかを確認します。
    
- E2Eテスト（End to Endテスト）
    
    実際のユーザー操作をシミュレートして、最も広範囲な結合テストを行います。  
    Cypress、Selenium、Playwright などのツールがあります。  
    ユーザーがアプリケーションを使用する際のシナリオを再現し、すべてのコンポーネントが連携して正しく機能しているかを確認します。


### 目的によって実施するテスト

- パフォーマンステスト
    
    アプリケーションの応答性や安定性、スケーラビリティを測定するテストです。  
    Lighthouse、WebPageTest、JMeter などのツールがあります。  
    アプリケーションが高負荷の状況でも適切に動作するかを検証し、ユーザー体験を最適化することを目指します。

- アクセシビリティテスト
    
    アプリケーションが多様なユーザーにとって利用可能であるのかを検証するテストです。  
    axe、WAVE などのツールがあります。  
    ユーザーインターフェースがすべての人にとってアクセス可能であることを確認し、標準やガイドラインに準拠していることを目指します。

これらのテストを全て実施するべきであったとしても、現実的にはリソースに限りがあります。  
このような場合は、プロジェクトの特性やビジネス要件、チームの規模、技術スタックなどを考慮し、テストの優先順位をつけることが重要になります。  

テストの分類とそれぞれの目的を理解したら、これらをプロダクトにどう嵌め込んでいくのかイメージがついてくると思います。  

## どのようにテスト戦略を考えるのか
テスト戦略についても既にいくつかのモデルがあります。これらをベースにして、テスト戦略を考えていくこともできます。  

### テストピラミッド型

![テストピラミッド型](/images/Pyramid.png)

E2Eテストなど、上層のテストほど実際の環境に忠実であり、再現性が高いです。その分、実行時間も長く、コストもかかります。  
テストピラミッド型は、下層のテストに比重を置いた、費用対効果の高い戦略モデルです。実行時間も高速であり、単体テストなどの細かい機能レベルでテストを行うので、失敗した際のリスクも抑えられます。  
手動テストのような、失敗する可能性があり、かつ時間もかかる、という上層のテストの比重を軽くする戦略です。  

### アイスクリームコーン型

![アイスクリームコーン型](/images/IceCreamCone.png)

テストピラミッド型に反して、アイスクリームコーン型は上層のテストを多く実行する戦略モデルで、主にアンチパターンとして参照されることが多いです。  
上層のテストは運用のコストも高く、失敗するリスクもあり、実行時間も長いです。このようなテストに比重を置いている場合、日常の開発フローに影響が出るため、開発サイクルを鈍化させる要因になり得ます。  

### テスティングトロフィー型

![テスティングトロフィー型](/images/Trophy.png)

テスティングトロフィー型は、結合テストに比重を置いた戦略モデルです。  
Web上のコンテンツは、実際には機能単体で成立するものは少なく、UI操作によって外部へリクエストを送信したり、複数のモジュールを組み合わせて実現するのが基本的です。  
ユーザー操作を起点としたテストに比重を置くべきと考える場合、結合テストを充実させる必要があります。  


テスト戦略について調べると、すぐに「テスティングトロフィー型が優れている」というような意見に行き着きます。  
しかし、目的を達成する為に戦略があり、戦略を達成することは目的ではないということを忘れてはいけません。  
テスト戦略モデルはあくまで指標であり、テスティングトロフィー型を意識する場合も、これに捉われないように戦略を立てると良いと思います。 

## 自分で考えるテスト戦略
テストの種類やテストの戦略についてはある程度理解したので、自分達のプロダクトにおいてどのようなテスト戦略を立てるべきなのかを考えます。  
まずは、現プロダクトのテスト戦略の状況について理解するべきです。

### 現プロダクトの戦略モデル
私の現在のプロダクトを、仮にモデル化した場合、どのような戦略になるのかを図にしてみました。

![バルーン型](/images/Balloon.png)

バルーンのように上層が膨らんでいるので、テスティングバルーン型などと勝手に名づけることにします。  
手動テストが全体の大部分を占めており、結合テストはほぼありません。  
このような戦略は、アプリケーションの構造がシンプルであり、テストの実施頻度が限られる短期的なプロジェクトにおいては効果がありそうです。  
また、リリース後のユーザーフィードバックを受けて改善を行うことを前提としている場合、結合テストを省略しても一定は問題がなさそうです。  

我々のプロジェクトがそれを意図しているのであれば、このテスティングバルーン型でも何も問題はないと判断するべきです。  
しかし、実際にはアプリの正常性を確認する為だけの基礎的なスルーテストすら手動で行なっており、それが高頻度で発生するため、手動テストの比重は重いです。これは実行コストだけでなくヒューマンエラーを起こしやすい仕組みであるとも言えます。  

また、ユーザーインタラクション起因による外部APIへのリクエストなども頻繁に発生しており、複数のモジュールの相互作用を確認することはアプリケーションにとって重要です。  
これらの観点が不足していることを考慮し、結合テストの充実化と、E2Eテストの導入をメインに検討していきます。  

### 目的を定める
現プロジェクトの課題は、手動テストの発生頻度が高く、その比重が重いこと、またヒューマンエラーが起こりやすいためリスクの高い運用であると言えます。  



#### 結合テストについて
現段階で結合テストはほぼ未実施の状態で、少なくとも意識的に書かれた形跡はありません。  
結合テストを充実化させるために、テスト設計書を作成することにします。現在のテストがどのようなテストケースで、どのような目的を持っているのかを明らかにし、不足している観点を網羅していきます。  
![テスト設計書](/images/testSheet.png)

また、テスト設計書を作成する上で、テストケースがドキュメントの役割を満たせているかどうかもチェックし、不足している場合は改善していきます。  
既存のテストでは、props から渡ってくるパラメータによって表示を切り替える場合のテストケースを「(props)の有無」などとして Assert していたりしました。  
これでは表示が切り替わる条件がこのテストから解明できないため、仕様を汲み取ることができません。こういった観点も修正対象に加えて、テスト設計書とテストケースがイコールになるよう手を加えていきます。  

テスト設計書では、